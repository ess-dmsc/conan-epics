stages:
  - container_build_node

variables:
  CONAN_USER: "ess-dmsc"
  CONAN_PKG_CHANNEL: "stable"
  PROJECT_NAME: "conan-epics"

# Container Build Node Stage so the Conan package can be built for all platforms
container_build_node:
  stage: container_build_node
  tags:
    - dc-zone
    - docker
  parallel:
    matrix:
      - CONTAINER: "centos7-gcc11"
        IMAGE: "registry.esss.lu.se/ecdc/ess-dmsc/docker-centos7-build-node:12.3.0"
        SHELL: "/usr/bin/scl enable devtoolset-11 rh-python38 -- /bin/bash -e -x"
      - CONTAINER: "almalinux8-gcc12"
        IMAGE: "registry.esss.lu.se/ecdc/ess-dmsc/docker-almalinux8-build-node:1.1.0"
        SHELL: "/usr/bin/scl enable gcc-toolset-12 -- /bin/bash -e -x"
      - CONTAINER: "debian11"
        IMAGE: "registry.esss.lu.se/ecdc/ess-dmsc/docker-debian11-build-node:5.2.0"
        SHELL: "bash -e -x"
      - CONTAINER: "ubuntu2204"
        IMAGE: "registry.esss.lu.se/ecdc/ess-dmsc/docker-ubuntu2204-build-node:5.0.0"
        SHELL: "bash -e -x"
  image: $IMAGE
  script:
    - echo "Starting build job for $PROJECT_NAME on $CONTAINER"
    - |
      $SHELL <<EOF
        # Sourcing GitLab CI functions
        source .ci_functions.sh
        setup_conan
        cd archiving
        ./generate-conanfile.sh "${CONAN_USER}" "${CONAN_PKG_CHANNEL}" 

        mkdir epics
        cd epics

        echo 'Conan installation...'
        conan install .. --build=missing

        # Upload conan packages if this is the target container
        if [[ "$CI_COMMIT_REF_NAME" != "master" ]]; then
          echo "Skipping upload stage: only the master branch can upload to the stable channel"
        else
          # Upload conan packages if this is the target container
          upload_packages_if_target_container "$CONTAINER" "centos7-gcc11" "$CONAN_USER" "$CONAN_PKG_CHANNEL" "../.."
        fi

        echo "Archiving build artifacts..."
        # Remove additional files generated by Conan
        rm conan*
        rm graph_info.json

        create_build_info
      EOF
    - cd archiving
    - tar czvf ../epics.tar.gz epics
  variables:
    conan_remote_name: "ecdc-conan-external"
    conan_remote_url: "https://artifactory.esss.lu.se/artifactory/api/conan/ecdc-conan-external"

  artifacts:
    paths:
      - epics.tar.gz
    expire_in: 1 month

# Clean up after the build
after_script:
  - echo "Cleaning workspace"
  - rm -rf epics
